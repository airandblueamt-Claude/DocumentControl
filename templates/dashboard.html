<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Control - Email Monitor</title>
    <script>(function(){var t=localStorage.getItem('theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark');})();</script>
    <style>
        :root {
            --bg: #f4f6f9;
            --card: #fff;
            --border: #e2e6ed;
            --text: #1e293b;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warn: #f59e0b;
            --purple: #8b5cf6;
            --header-bg: #0f172a;
            --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.12);
            --radius: 10px;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --text-light: #64748b;
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --success: #34d399;
            --success-dark: #10b981;
            --danger: #f87171;
            --danger-dark: #ef4444;
            --warn: #fbbf24;
            --purple: #a78bfa;
            --header-bg: #020617;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.5);
        }
        [data-theme="dark"] thead th { background: #0f172a; color: var(--text-muted); }
        [data-theme="dark"] .search-box { background-color: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .search-box:focus { background-color: var(--card); }
        [data-theme="dark"] .modal-body-text { background: #0f172a; border-color: var(--border); color: #cbd5e1; }
        [data-theme="dark"] .sender-known { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .sender-unknown { background: #78350f; color: #fcd34d; }
        [data-theme="dark"] .ai-badge.conf-high { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .ai-badge.conf-mid { background: #78350f; color: #fcd34d; }
        [data-theme="dark"] .ai-badge.conf-low { background: #7f1d1d; color: #fca5a5; }
        [data-theme="dark"] .ai-badge.conf-none { background: #334155; color: var(--text-muted); }
        [data-theme="dark"] .filter-pill { background: #0f172a; border-color: var(--border); color: var(--text-muted); }
        [data-theme="dark"] .filter-pill:hover { border-color: var(--primary); }
        [data-theme="dark"] .filter-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        [data-theme="dark"] .form-group input { background: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .form-group input:focus { border-color: var(--primary); }
        [data-theme="dark"] .inline-select { background: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .clf-select { background: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .modal-select { background: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .ai-textarea { background: #0f172a; color: var(--text); border-color: var(--border); }
        [data-theme="dark"] .clf-badge { background: #334155; color: var(--text); }
        [data-theme="dark"] .key-pill.on { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .key-pill.off { background: #334155; color: var(--text-light); }
        [data-theme="dark"] .card-tag { background: #334155; color: var(--text-muted); }
        [data-theme="dark"] .tag { background: #334155; color: var(--text-muted); }
        [data-theme="dark"] .view-toggle { background: #0f172a; color: var(--text-muted); border-color: var(--border); }
        [data-theme="dark"] .view-toggle:hover { background: #334155; }
        [data-theme="dark"] tbody tr:hover { background: #334155; }
        [data-theme="dark"] tbody tr { border-bottom-color: #334155; }
        [data-theme="dark"] .email-cards { background: #0f172a; }
        [data-theme="dark"] .email-card:active { background: #334155; }
        [data-theme="dark"] .step-card { background: #334155; }
        [data-theme="dark"] .page-btn { background: var(--card); color: var(--text-muted); border-color: var(--border); }
        [data-theme="dark"] .page-btn:hover { background: #334155; color: var(--text); }
        [data-theme="dark"] .error-msg { background: #451a1a; }
        [data-theme="dark"] .modal-close:hover { background: #334155; }
        [data-theme="dark"] .btn-ghost { color: var(--text-muted); border-color: var(--border); }
        [data-theme="dark"] .btn-ghost:hover { background: #334155; color: var(--text); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        /* ---- Header ---- */
        header {
            background: var(--header-bg);
            color: #fff;
            padding: 0 16px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
        }
        header h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .status-pill {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; font-weight: 500;
            padding: 4px 10px; border-radius: 20px;
            background: rgba(255,255,255,0.08);
        }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .status-dot.idle { background: #22c55e; }
        .status-dot.scanning { background: var(--warn); animation: pulse 1s infinite; }
        .status-dot.error { background: var(--danger); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

        /* ---- Tabs ---- */
        .tab-bar {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 8px;
        }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab-btn {
            padding: 12px 14px;
            font-size: 13px; font-weight: 600;
            color: var(--text-muted);
            background: none; border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all .15s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-badge {
            display: inline-block; background: var(--danger); color: #fff;
            font-size: 10px; font-weight: 700;
            min-width: 18px; height: 18px; line-height: 18px;
            text-align: center; border-radius: 9px;
            padding: 0 5px; margin-left: 4px;
        }
        .tab-badge.zero { background: var(--text-light); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ---- Layout ---- */
        .container { max-width: 1440px; margin: 0 auto; padding: 12px; }

        /* ---- Control Bar (scanner + classifier) ---- */
        .control-bar {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px;
        }
        .control-card {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 12px 14px;
        }
        .control-card.scanner {
            display: flex; flex-direction: column; gap: 10px;
        }
        .control-card.classifier { display: flex; flex-direction: column; gap: 6px; }
        .ctrl-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .ctrl-item { display: flex; flex-direction: column; }
        .ctrl-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; letter-spacing: .5px; font-weight: 600; }
        .ctrl-value { font-size: 12px; font-weight: 600; color: var(--text); word-break: break-word; }
        .ctrl-value.ok { color: var(--success); }
        .ctrl-value.err { color: var(--danger); }
        .scanner-actions { display: flex; justify-content: flex-end; }

        .clf-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .clf-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: 11px; font-weight: 600;
            padding: 4px 10px; border-radius: 6px;
            background: #f1f5f9; color: var(--text);
            word-break: break-word;
        }
        .clf-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .clf-dot.ai { background: var(--purple); }
        .clf-dot.keywords { background: var(--warn); }
        .clf-keys { display: flex; gap: 4px; flex-wrap: wrap; }
        .key-pill {
            font-size: 10px; font-weight: 600;
            padding: 2px 7px; border-radius: 4px;
        }
        .key-pill.on { background: #dcfce7; color: #166534; }
        .key-pill.off { background: #f1f5f9; color: var(--text-light); }

        /* ---- Buttons ---- */
        .btn {
            border: none; padding: 8px 14px; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all .15s; white-space: nowrap;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: #fff; }
        .btn-success:hover { background: var(--success-dark); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-danger:hover { background: var(--danger-dark); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f8fafc; color: var(--text); }
        .btn:disabled { opacity: .45; cursor: not-allowed; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-scan { padding: 10px 20px; font-size: 13px; width: 100%; }

        /* ---- Table Card ---- */
        .table-card {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 12px;
        }
        .table-toolbar {
            display: flex; flex-direction: column; gap: 8px;
            padding: 12px 14px; border-bottom: 1px solid var(--border);
        }
        .toolbar-top { display: flex; justify-content: space-between; align-items: center; }
        .toolbar-top h2 { font-size: 15px; font-weight: 700; white-space: nowrap; }
        .toolbar-controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .bulk-bar { display: flex; align-items: center; gap: 6px; }
        .bulk-count { font-size: 12px; color: var(--text-muted); font-weight: 500; }

        /* Search input */
        .search-box {
            padding: 8px 12px 8px 34px;
            border: 1px solid var(--border); border-radius: 6px;
            font-size: 14px; width: 100%;
            background: #f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") 10px center no-repeat;
            transition: border-color .15s;
        }
        .search-box:focus { border-color: var(--primary); outline: none; background-color: #fff; }

        /* View toggle */
        .view-toggle {
            padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 10px; font-weight: 700; cursor: pointer;
            background: #fff; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: .4px;
            white-space: nowrap; flex-shrink: 0;
        }
        .view-toggle:hover { background: #f8fafc; }
        .view-toggle.expanded { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* ---- Mobile Card Layout (for tables on small screens) ---- */
        .email-cards { display: flex; flex-direction: column; gap: 1px; background: #f1f5f9; }
        .email-card {
            background: var(--card); padding: 12px 14px;
            display: flex; flex-direction: column; gap: 6px;
        }
        .email-card:active { background: #f8fafc; }
        .card-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
        .card-subject {
            font-weight: 600; font-size: 13px; color: var(--primary);
            cursor: pointer; word-break: break-word; flex: 1;
        }
        .card-meta {
            font-size: 11px; color: var(--text-muted);
            display: flex; flex-wrap: wrap; gap: 4px 12px; align-items: center;
        }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .card-tag {
            font-size: 10px; font-weight: 600; padding: 2px 8px;
            border-radius: 4px; background: #f1f5f9; color: var(--text-muted);
        }

        /* ---- Filter Pills ---- */
        .filter-pills {
            display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
        }
        .filter-pill {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
            border: 1px solid var(--border); background: #fff;
            color: var(--text-muted); cursor: pointer;
            transition: all .15s; white-space: nowrap;
        }
        .filter-pill:hover { border-color: var(--primary); color: var(--text); }
        .filter-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .filter-pill .pill-count {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 18px; height: 18px; line-height: 18px;
            font-size: 10px; font-weight: 700;
            border-radius: 9px; padding: 0 5px;
            background: rgba(0,0,0,0.08);
        }
        .filter-pill.active .pill-count { background: rgba(255,255,255,0.25); }
        .filter-pill.has-count .pill-count { background: var(--danger); color: #fff; }
        .filter-pill.active.has-count .pill-count { background: rgba(255,255,255,0.3); }
        .btn-move-review {
            background: var(--purple); color: #fff;
            border: none; padding: 5px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all .15s;
        }
        .btn-move-review:hover { opacity: 0.85; }
        .card-actions { display: flex; gap: 6px; }
        .card-check { display: flex; align-items: center; padding-right: 8px; }

        /* Table (desktop) */
        .table-wrap { overflow-x: auto; display: none; }
        table {
            width: 100%; border-collapse: collapse;
            font-size: 12px; table-layout: auto;
        }
        thead th {
            text-align: left; padding: 10px 12px;
            background: #f8fafc; color: var(--text-muted);
            font-weight: 600; font-size: 10px;
            text-transform: uppercase; letter-spacing: .4px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            position: sticky; top: 0; z-index: 2;
        }
        tbody tr { border-bottom: 1px solid #f1f5f9; transition: background .1s; }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: #f8fafc; }
        tbody td { padding: 10px 12px; vertical-align: top; }
        td.col-num { color: var(--text-light); font-size: 11px; font-weight: 500; text-align: center; width: 30px; }
        td.col-subject { max-width: 360px; }
        td.col-sender { max-width: 180px; }
        td.col-subject, td.col-sender {
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .table-expanded td.col-subject,
        .table-expanded td.col-sender {
            max-width: none; white-space: normal;
            word-wrap: break-word; overflow-wrap: break-word;
        }
        td.col-actions { white-space: nowrap; }
        .subject-link { cursor: pointer; color: var(--primary); font-weight: 500; }
        .subject-link:hover { text-decoration: underline; }
        .inline-select {
            padding: 4px 6px; border: 1px solid var(--border); border-radius: 5px;
            font-size: 11px; background: #fff; cursor: pointer; max-width: 100px;
        }
        .inline-select:focus { border-color: var(--primary); outline: none; }
        .row-actions { display: flex; gap: 4px; }
        input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; accent-color: var(--primary); }
        .empty-state { padding: 40px 16px; text-align: center; color: var(--text-light); font-size: 14px; }

        /* Sender badges */
        .sender-known, .sender-unknown {
            display: inline-block; font-size: 9px; font-weight: 700;
            padding: 1px 6px; border-radius: 4px; margin-left: 4px; vertical-align: middle;
        }
        .sender-known { background: #dcfce7; color: #166534; }
        .sender-unknown { background: #fef3c7; color: #92400e; }
        .sender-company { display: block; font-size: 11px; color: var(--text-muted); margin-top: 1px; }
        .resp-yes { color: var(--danger); font-weight: 600; }
        .resp-no { color: var(--text-light); }

        /* Thread badges */
        .thread-badge {
            display: inline-block; font-size: 9px; font-weight: 700;
            padding: 1px 6px; border-radius: 4px; margin-left: 4px; vertical-align: middle;
        }
        .thread-badge.new-topic { background: #dcfce7; color: #166534; }
        .thread-badge.follow-up { background: #dbeafe; color: #1e40af; }
        .thread-badge.thread-count { background: #f3e8ff; color: #6b21a8; }
        .thread-badge.auto-assigned { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .thread-badge.new-topic { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .thread-badge.follow-up { background: #1e3a5f; color: #93c5fd; }
        [data-theme="dark"] .thread-badge.thread-count { background: #3b0764; color: #c4b5fd; }
        [data-theme="dark"] .thread-badge.auto-assigned { background: #1e3a5f; color: #93c5fd; }

        /* Conversation timeline */
        .conv-timeline { margin-top: 12px; padding: 0 0 0 16px; border-left: 2px solid var(--border); }
        .conv-timeline-item {
            position: relative; padding: 8px 0 8px 16px; font-size: 12px;
            color: var(--text-muted);
        }
        .conv-timeline-item::before {
            content: ''; position: absolute; left: -21px; top: 12px;
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--border);
        }
        .conv-timeline-item.current::before { background: var(--primary); }
        .conv-timeline-item.current { color: var(--text); font-weight: 600; }
        .conv-timeline-item .tl-date { font-weight: 600; margin-right: 6px; }
        .conv-timeline-item .tl-sender { margin-right: 6px; }
        .conv-timeline-item .tl-subject { font-style: italic; }
        .conv-timeline-item .tl-status {
            display: inline-block; font-size: 10px; font-weight: 700;
            padding: 1px 6px; border-radius: 4px; margin-left: 6px;
        }
        .tl-status.approved { background: #dcfce7; color: #166534; }
        .tl-status.pending { background: #fef3c7; color: #92400e; }
        .tl-status.auto { background: #dbeafe; color: #1e40af; }
        [data-theme="dark"] .tl-status.approved { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .tl-status.pending { background: #78350f; color: #fcd34d; }
        [data-theme="dark"] .tl-status.auto { background: #1e3a5f; color: #93c5fd; }
        .conv-timeline-link { cursor: pointer; }
        .conv-timeline-link:hover { color: var(--primary); }

        /* Processed table: expand/collapse follow-ups */
        .expand-btn {
            background: none; border: 1px solid var(--border); border-radius: 4px;
            cursor: pointer; font-size: 10px; font-weight: 700;
            padding: 2px 8px; color: var(--primary); transition: all .15s;
            white-space: nowrap;
        }
        .expand-btn:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
        .follow-up-row td { background: var(--bg); font-size: 11px; }
        .follow-up-row td:first-child { padding-left: 28px; }
        .follow-up-indicator { color: var(--text-light); font-size: 10px; margin-right: 4px; }
        [data-theme="dark"] .follow-up-row td { background: #0f172a; }
        /* Mobile follow-up card */
        .follow-up-card {
            margin-left: 16px; border-left: 2px solid var(--primary);
            padding: 8px 12px; font-size: 12px;
            background: var(--bg); border-radius: 0 var(--radius) var(--radius) 0;
        }
        .follow-up-card .card-meta { font-size: 11px; }
        [data-theme="dark"] .follow-up-card { background: #0f172a; }

        /* Attachments */
        .att-list { display: flex; flex-direction: column; gap: 2px; }
        .att-list a {
            font-size: 11px; color: var(--primary); text-decoration: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 160px; display: block;
        }
        .att-list a:hover { text-decoration: underline; }
        .att-list a.att-signature { color: var(--text-light); text-decoration: line-through; }
        .att-size { color: var(--text-light); font-size: 9px; margin-left: 2px; }
        .tag-signature {
            background: #fef3c7; color: #92400e;
            font-size: 9px; font-weight: 600;
            padding: 1px 5px; border-radius: 4px; margin-left: 3px;
        }

        /* Tags */
        .tag {
            display: inline-block; background: #f1f5f9; color: var(--text-muted);
            font-size: 10px; padding: 2px 8px; border-radius: 4px; margin: 1px;
        }
        .active-badge { color: var(--success); font-weight: 600; }
        .inactive-badge { color: var(--text-light); font-weight: 600; }

        /* ---- Stats Cards ---- */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; }
        .stat-card {
            background: var(--card); border-radius: var(--radius);
            padding: 14px 16px; box-shadow: var(--shadow);
        }
        .stat-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 2px; }
        .stat-card .value { font-size: 24px; font-weight: 800; color: var(--text); }

        /* ---- Log Panel ---- */
        .log-panel { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 12px; }
        .log-header {
            padding: 12px 14px; border-bottom: 1px solid var(--border);
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; user-select: none;
        }
        .log-header h2 { font-size: 15px; font-weight: 700; }
        .log-header .toggle { font-size: 16px; color: var(--text-light); }
        .log-body {
            display: none; max-height: 260px; overflow-y: auto;
            padding: 12px; background: #0f172a; border-radius: 0 0 var(--radius) var(--radius);
        }
        .log-body.open { display: block; }
        .log-line {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px; color: #94a3b8; line-height: 1.7;
            white-space: pre-wrap; word-break: break-all;
        }

        /* ---- Forms ---- */
        .add-form {
            display: flex; flex-direction: column; gap: 10px;
            padding: 12px 14px; border-bottom: 1px solid var(--border);
        }
        .form-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 120px; }
        .form-group label { font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: .3px; }
        .form-group input {
            padding: 8px 12px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 14px; transition: border-color .15s;
            width: 100%;
        }
        .form-group input:focus { border-color: var(--primary); outline: none; }

        /* ---- Toast ---- */
        .toast-container { position: fixed; top: 58px; right: 12px; left: 12px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast {
            padding: 12px 16px; border-radius: 8px; color: #fff;
            font-size: 13px; font-weight: 500;
            box-shadow: var(--shadow-lg); animation: slideIn .25s ease;
            pointer-events: auto; margin-left: auto;
            max-width: 380px;
        }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }
        @keyframes slideIn { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* ---- Detail Modal ---- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(15,23,42,0.6); backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center; align-items: flex-start;
            padding: 0; overflow-y: auto;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--card);
            width: 100%; min-height: 100vh;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; background: var(--card); z-index: 1;
        }
        .modal-header h2 { font-size: 14px; font-weight: 700; flex: 1; margin-right: 8px; word-break: break-word; }
        .modal-close {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: var(--text-light); width: 36px; height: 36px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .modal-close:hover { background: #f1f5f9; color: var(--text); }
        .modal-body { padding: 16px; }
        .modal-field { margin-bottom: 14px; }
        .modal-field-label { font-size: 10px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; }
        .modal-field-value { font-size: 13px; color: var(--text); word-break: break-word; }
        .modal-body-text {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 8px;
            padding: 12px; max-height: 320px; overflow-y: auto;
            white-space: pre-wrap; word-wrap: break-word;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px; line-height: 1.6; color: #334155;
        }
        .modal-fields-row { display: flex; flex-direction: column; gap: 12px; margin-bottom: 14px; }
        .modal-fields-row .modal-field { margin-bottom: 0; }
        .modal-att-list { display: flex; flex-direction: column; gap: 6px; }
        .modal-att-item { display: flex; align-items: center; gap: 8px; font-size: 12px; flex-wrap: wrap; }
        .modal-att-item a { color: var(--primary); text-decoration: none; font-weight: 500; word-break: break-all; }
        .modal-att-item a:hover { text-decoration: underline; }
        .modal-att-item.signature a { color: var(--text-light); text-decoration: line-through; }
        .modal-footer {
            display: flex; gap: 8px;
            padding: 14px 16px; border-top: 1px solid var(--border);
            position: sticky; bottom: 0; background: var(--card);
        }
        .modal-footer .btn { padding: 10px 20px; font-size: 14px; flex: 1; }
        .modal-select {
            padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 13px; background: #fff; cursor: pointer; width: 100%;
        }
        .modal-select:focus { border-color: var(--primary); outline: none; }
        .body-toggle {
            display: inline-block; margin-top: 8px; font-size: 12px;
            color: var(--primary); cursor: pointer; font-weight: 600;
        }
        .body-toggle:hover { text-decoration: underline; }

        /* ---- Pagination ---- */
        .table-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-top: 1px solid var(--border);
            font-size: 12px; color: var(--text-muted);
            flex-wrap: wrap; gap: 8px;
        }
        .pagination { display: flex; gap: 4px; flex-wrap: wrap; }
        .page-btn {
            padding: 6px 10px; border: 1px solid var(--border); border-radius: 5px;
            background: #fff; cursor: pointer; font-size: 12px; font-weight: 500; color: var(--text-muted);
            min-width: 32px; text-align: center;
        }
        .page-btn:hover { background: #f8fafc; color: var(--text); }
        .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .page-btn:disabled { opacity: .4; cursor: not-allowed; }

        /* ==== DESKTOP (768px+) ==== */
        @media (min-width: 768px) {
            body { font-size: 13px; }
            header { padding: 0 24px; height: 56px; }
            header h1 { font-size: 16px; }
            .tab-bar { padding: 0 24px; gap: 4px; }
            .tab-btn { padding: 14px 18px; }
            .container { padding: 20px 24px; }

            .control-bar { flex-direction: row; gap: 14px; }
            .control-card { padding: 16px 20px; }
            .control-card.scanner { flex: 1; flex-direction: row; align-items: center; gap: 20px; }
            .ctrl-items { grid-template-columns: repeat(4, auto); gap: 24px; flex: 1; }
            .scanner-actions { justify-content: flex-start; }
            .btn-scan { width: auto; padding: 9px 22px; }
            .control-card.classifier { min-width: 260px; }

            .table-toolbar { flex-direction: row; justify-content: space-between; align-items: center; padding: 14px 18px; }
            .toolbar-controls { flex-wrap: nowrap; }
            .search-box { width: 220px; }

            /* Show table, hide cards on desktop */
            .table-wrap { display: block !important; }
            .email-cards { display: none !important; }

            /* Modal */
            .modal-overlay { padding: 40px 20px; }
            .modal { border-radius: 14px; max-width: 780px; min-height: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.25); }
            .modal-header { position: static; padding: 18px 24px; }
            .modal-header h2 { font-size: 16px; }
            .modal-body { padding: 24px; max-height: 68vh; overflow-y: auto; }
            .modal-footer { position: static; padding: 16px 24px; }
            .modal-footer .btn { flex: none; }
            .modal-fields-row { flex-direction: row; gap: 16px; }

            /* Forms */
            .add-form { flex-direction: row; flex-wrap: wrap; align-items: flex-end; }
            .form-group { min-width: 0; flex: none; }

            /* Stats */
            .stat-card .value { font-size: 30px; }

            /* Toast */
            .toast-container { left: auto; right: 16px; top: 16px; }
        }

        /* ==== LARGE DESKTOP (1024px+) ==== */
        @media (min-width: 1024px) {
            .container { padding: 20px 28px; }
        }

        /* ==== SMALL MOBILE (< 400px) ==== */
        @media (max-width: 400px) {
            header h1 { font-size: 13px; }
            .status-pill { font-size: 10px; padding: 3px 8px; }
            .tab-btn { padding: 10px 10px; font-size: 12px; }
            .stats-row { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .stat-card { padding: 10px 12px; }
            .stat-card .value { font-size: 20px; }
            .btn-sm { padding: 4px 8px; font-size: 11px; }
        }

        /* ---- Home Page ---- */
        .home-hero {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px 20px;
            margin-bottom: 16px; text-align: center;
        }
        .home-hero h2 { font-size: 20px; font-weight: 800; margin-bottom: 8px; color: var(--text); }
        .home-hero p { font-size: 14px; color: var(--text-muted); max-width: 600px; margin: 0 auto; line-height: 1.6; }
        .home-stats {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            margin-bottom: 16px;
        }
        .home-stat-card {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 16px; text-align: center;
        }
        .home-stat-value { font-size: 28px; font-weight: 800; color: var(--primary); }
        .home-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; font-weight: 600; margin-top: 2px; }
        .home-steps { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
        .home-steps h3 { font-size: 16px; font-weight: 700; margin-bottom: 14px; }
        .steps-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .step-card {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 12px; border-radius: 8px; background: #f8fafc;
        }
        .step-num {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 800; flex-shrink: 0;
        }
        .step-title { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .step-desc { font-size: 12px; color: var(--text-muted); line-height: 1.5; }

        @media (min-width: 768px) {
            .home-hero { padding: 36px 28px; }
            .home-hero h2 { font-size: 26px; }
            .home-stats { grid-template-columns: repeat(4, 1fr); }
            .home-stat-value { font-size: 34px; }
            .steps-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* ---- Classifier Select ---- */
        .clf-select {
            padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 12px; font-weight: 600; background: #fff; cursor: pointer;
            color: var(--text); width: 100%; max-width: 220px;
        }
        .clf-select:focus { border-color: var(--primary); outline: none; }
        .clf-source { font-size: 10px; color: var(--text-light); font-weight: 500; }
        .clf-chain { font-size: 11px; color: var(--text-muted); font-weight: 500; margin-top: 2px; }

        /* AI classifier badges on emails */
        .ai-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 600; padding: 2px 7px;
            border-radius: 4px; white-space: nowrap;
        }
        .ai-badge .ai-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
        .ai-badge.conf-high { background: #dcfce7; color: #166534; }
        .ai-badge.conf-high .ai-dot { background: #16a34a; }
        .ai-badge.conf-mid { background: #fef3c7; color: #92400e; }
        .ai-badge.conf-mid .ai-dot { background: #d97706; }
        .ai-badge.conf-low { background: #fee2e2; color: #991b1b; }
        .ai-badge.conf-low .ai-dot { background: #dc2626; }
        .ai-badge.conf-none { background: #f1f5f9; color: var(--text-muted); }
        .ai-badge.conf-none .ai-dot { background: var(--text-light); }

        /* AI Instructions section */
        .ai-instructions { margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }
        .ai-instructions-header {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        .ai-instructions-header .ctrl-label { margin: 0; }
        .ai-instructions-toggle { font-size: 14px; color: var(--text-light); transition: transform .2s; }
        .ai-instructions-toggle.open { transform: rotate(180deg); }
        .ai-instructions-body { display: none; margin-top: 6px; }
        .ai-instructions-body.open { display: block; }
        .ai-textarea {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 12px; font-family: inherit;
            resize: vertical; min-height: 60px; transition: border-color .15s;
        }
        .ai-textarea:focus { border-color: var(--primary); outline: none; }
        .ai-textarea::placeholder { color: var(--text-light); }
        .ai-instructions-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; gap: 8px; }
        .ai-instructions-meta { font-size: 10px; color: var(--text-light); }

        /* Department description */
        .dept-desc {
            font-size: 11px; color: var(--text-muted); margin-top: 2px;
            font-style: italic; word-break: break-word;
        }

        /* ---- Dark Mode Toggle (F6) ---- */
        .dark-toggle {
            background: transparent; border: none; color: #fff;
            font-size: 18px; cursor: pointer; padding: 4px 6px;
            border-radius: 6px; display: flex; align-items: center;
            justify-content: center; transition: background .15s;
        }
        .dark-toggle:hover { background: rgba(255,255,255,0.1); }

        /* ---- Logout Button (F1) ---- */
        .header-link {
            color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 600;
            text-decoration: none; padding: 4px 8px; border-radius: 4px;
            transition: all .15s;
        }
        .header-link:hover { color: #fff; background: rgba(255,255,255,0.1); }

        /* ---- Classifier Notice (F2) ---- */
        .classifier-notice {
            background: #fef3c7; color: #92400e;
            font-size: 12px; font-weight: 500;
            padding: 8px 14px; border-radius: 8px;
            margin-bottom: 10px; display: none;
        }
        [data-theme="dark"] .classifier-notice { background: #78350f; color: #fcd34d; }

        /* ---- Body View Toggle (F5) ---- */
        .body-view-toggle {
            display: inline-flex; gap: 0; border-radius: 6px; overflow: hidden;
            border: 1px solid var(--border); margin-bottom: 8px;
        }
        .body-view-btn {
            padding: 5px 12px; font-size: 11px; font-weight: 600;
            border: none; cursor: pointer;
            background: var(--card); color: var(--text-muted);
            transition: all .15s;
        }
        .body-view-btn.active { background: var(--primary); color: #fff; }
        .body-view-btn:hover:not(.active) { background: #f1f5f9; }
        [data-theme="dark"] .body-view-btn:hover:not(.active) { background: #334155; }
        .modal-body-html {
            border: 1px solid var(--border); border-radius: 8px;
            width: 100%; min-height: 200px; max-height: 400px;
            background: #fff;
        }

        /* ---- Reopen Button (F3) ---- */
        .btn-reopen {
            background: var(--purple); color: #fff;
            border: none; padding: 5px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all .15s;
        }
        .btn-reopen:hover { opacity: 0.85; }

        /* ---- Quick Approve Button (Feature 5) ---- */
        .btn-quick-approve {
            background: var(--success); color: #fff;
            border: none; padding: 5px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all .15s;
            animation: quickGlow 2s ease-in-out infinite;
        }
        .btn-quick-approve:hover { background: var(--success-dark); }
        @keyframes quickGlow {
            0%,100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
            50% { box-shadow: 0 0 8px 2px rgba(16,185,129,0.25); }
        }

        /* ---- AI Assistant Panel (Feature 4) ---- */
        .ai-assistant-panel {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f5e9 100%);
            border: 1px solid #c3dafe;
            border-radius: 8px;
            padding: 12px 14px;
            margin: 10px 0;
        }
        [data-theme="dark"] .ai-assistant-panel {
            background: linear-gradient(135deg, #1e293b 0%, #1a2e1a 100%);
            border-color: #334155;
        }
        .ai-panel-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--purple); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .ai-panel-summary {
            font-size: 13px; line-height: 1.5; color: var(--text);
            margin-bottom: 8px;
        }
        .ai-panel-row {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .priority-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 11px; font-weight: 700;
            padding: 3px 8px; border-radius: 4px;
        }
        .priority-high { background: #fef2f2; color: #dc2626; }
        .priority-medium { background: #fffbeb; color: #d97706; }
        .priority-low { background: #f0fdf4; color: #16a34a; }
        [data-theme="dark"] .priority-high { background: #7f1d1d; color: #fca5a5; }
        [data-theme="dark"] .priority-medium { background: #78350f; color: #fcd34d; }
        [data-theme="dark"] .priority-low { background: #064e3b; color: #6ee7b7; }
        .ai-suggestion {
            font-size: 12px; font-weight: 600; color: var(--text-muted);
        }
        .ai-suggestion .suggest-action { color: var(--success); font-weight: 700; }
        .ai-suggestion .suggest-review { color: var(--warn); font-weight: 700; }

        /* ---- Card Summary (Feature 4E) ---- */
        .card-summary {
            font-size: 12px; color: var(--text-muted); line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; margin-top: 2px;
        }

        /* ---- Scan Progress Bar (Feature 6) ---- */
        .scan-progress {
            background: var(--card); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 12px 14px;
            margin-bottom: 12px; display: none;
        }
        .scan-progress.active { display: block; }
        .progress-bar-wrap {
            background: var(--border); border-radius: 6px;
            height: 8px; overflow: hidden; margin-bottom: 8px;
        }
        .progress-bar-fill {
            background: var(--primary); height: 100%; border-radius: 6px;
            transition: width 0.3s ease;
        }
        .progress-info {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; color: var(--text-muted); flex-wrap: wrap; gap: 4px;
        }
        .progress-count { font-weight: 700; color: var(--text); }
        .progress-subject {
            font-size: 11px; color: var(--text-light);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 300px;
        }
        .progress-stats {
            display: flex; gap: 8px; flex-wrap: wrap;
            font-size: 11px; color: var(--text-muted);
        }
        .progress-stats span { white-space: nowrap; }
        .progress-phase {
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            color: var(--purple); letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Document Control</h1>
        <div class="header-right">
            <div class="status-pill">
                <span class="status-dot idle" id="headerDot"></span>
                <span id="headerStatus">Idle</span>
            </div>
            <button class="dark-toggle" id="darkToggle" onclick="toggleDarkMode()" title="Toggle dark mode">&#9790;</button>
            {% if auth_enabled %}<a class="header-link" href="/logout">Logout</a>{% endif %}
        </div>
    </header>

    <div class="tab-bar">
        <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">Home</button>
        <button class="tab-btn" data-tab="review" onclick="switchTab('review')">
            Review <span class="tab-badge zero" id="pendingBadge">0</span>
        </button>
        <button class="tab-btn" data-tab="processed" onclick="switchTab('processed')">Processed</button>
        <button class="tab-btn" data-tab="departments" onclick="switchTab('departments')">Depts</button>
        <button class="tab-btn" data-tab="contacts" onclick="switchTab('contacts')">Contacts</button>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="closeModalOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalSubject">--</h2>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-ghost" onclick="closeDetailModal()">Close</button>
                <button class="btn btn-danger" onclick="modalReject()">Reject</button>
                <button class="btn btn-success" onclick="modalApprove()">Approve</button>
            </div>
        </div>
    </div>

    <!-- HOME -->
    <div class="tab-panel active" id="tab-home">
        <div class="container">
            <div class="home-hero">
                <h2>Document Control Email Interface</h2>
                <p>Automatically scans your mailbox, classifies incoming correspondence using AI, and queues emails for your review. Approve to assign transmittal numbers, save attachments, and log everything to Excel.</p>
                <button class="btn btn-primary" onclick="switchTab('review')" style="margin-top:12px">Go to Review Queue</button>
            </div>
            <div class="home-stats" id="homeStats">
                <div class="home-stat-card">
                    <div class="home-stat-value" id="homePending">--</div>
                    <div class="home-stat-label">Pending Review</div>
                </div>
                <div class="home-stat-card">
                    <div class="home-stat-value" id="homeProcessed">--</div>
                    <div class="home-stat-label">Processed</div>
                </div>
                <div class="home-stat-card">
                    <div class="home-stat-value" id="homeDepts">--</div>
                    <div class="home-stat-label">Departments</div>
                </div>
                <div class="home-stat-card">
                    <div class="home-stat-value" id="homeContacts">--</div>
                    <div class="home-stat-label">Contacts</div>
                </div>
            </div>
            <div class="home-steps">
                <h3>How It Works</h3>
                <div class="steps-grid">
                    <div class="step-card">
                        <div class="step-num">1</div>
                        <div class="step-title">Scan</div>
                        <div class="step-desc">Connects to your mailbox via IMAP and fetches unread emails on a schedule or on demand.</div>
                    </div>
                    <div class="step-card">
                        <div class="step-num">2</div>
                        <div class="step-title">Classify</div>
                        <div class="step-desc">AI or keyword-based engine categorizes each email by document type, discipline, and department.</div>
                    </div>
                    <div class="step-card">
                        <div class="step-num">3</div>
                        <div class="step-title">Review</div>
                        <div class="step-desc">You review, edit classifications, then approve or reject from the dashboard.</div>
                    </div>
                    <div class="step-card">
                        <div class="step-num">4</div>
                        <div class="step-title">Track</div>
                        <div class="step-desc">Approved emails get a transmittal number, attachments are saved, and everything is logged to Excel.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REVIEW QUEUE -->
    <div class="tab-panel" id="tab-review">
        <div class="container">
            <div class="control-bar">
                <div class="control-card scanner">
                    <div class="ctrl-items">
                        <div class="ctrl-item"><span class="ctrl-label">Status</span><span class="ctrl-value" id="scanStatus">--</span></div>
                        <div class="ctrl-item"><span class="ctrl-label">Last Scan</span><span class="ctrl-value" id="scanLast">--</span></div>
                        <div class="ctrl-item"><span class="ctrl-label">Result</span><span class="ctrl-value" id="scanResult">--</span></div>
                        <div class="ctrl-item"><span class="ctrl-label">Next Scan</span><span class="ctrl-value" id="scanNext">--</span></div>
                    </div>
                    <div class="scanner-actions">
                        <button class="btn btn-primary btn-scan" id="btnScan" onclick="triggerScan()">Scan Now</button>
                        <button class="btn btn-ghost btn-scan" id="btnScanAll" onclick="triggerScanAll()" title="Scan ALL emails in inbox (read + unread)  use once to catch everything">Scan All Emails</button>
                        <button class="btn btn-ghost btn-scan" id="btnReclassify" onclick="triggerReclassify()" title="Re-run classification on pending emails using current departments, contacts, and rules" style="border-color:var(--accent);">Re-classify</button>
                    </div>
                </div>
                <div class="control-card classifier">
                    <div class="ctrl-label">Classifier Engine</div>
                    <div class="clf-row">
                        <select class="clf-select" id="classifierSelect" onchange="changeClassifierMethod()">
                            <option value="auto">Auto (fallback chain)</option>
                            <option value="rule_based">Keywords Only</option>
                            <option value="gemini">Gemini</option>
                            <option value="groq">Groq</option>
                            <option value="claude_api">Claude API</option>
                        </select>
                    </div>
                    <div class="clf-source" id="classifierSource"></div>
                    <div class="clf-chain" id="classifierChain"></div>
                    <div class="clf-keys" id="classifierKeys"></div>
                    <div class="ai-instructions">
                        <div class="ai-instructions-header" onclick="toggleAiInstructions()">
                            <span class="ctrl-label">Custom Classification Rules</span>
                            <span class="ai-instructions-toggle" id="aiInstrToggle">&#9660;</span>
                        </div>
                        <div class="ai-instructions-body" id="aiInstrBody">
                            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;line-height:1.5">
                                Tell the AI how to classify your emails. These rules are sent to the classifier when it processes each incoming email. Write in plain English.
                            </div>
                            <textarea class="ai-textarea" id="aiInstructionsText" rows="5"
                                placeholder="Example rules:&#10;&#10;- Emails from @acme.com about 'site inspection' go to Civil department&#10;- 'MoM' or 'Minutes of Meeting' = doc type Meeting Minutes&#10;- Anything about fire alarm or sprinkler = MEP department&#10;- Submittal review emails from john@contractor.com = Architectural"></textarea>
                            <div class="ai-instructions-actions">
                                <span class="ai-instructions-meta" id="aiInstrMeta"></span>
                                <button class="btn btn-primary btn-sm" onclick="saveAiInstructions()">Save Rules</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scan Progress Bar (Feature 6) -->
            <div class="scan-progress" id="scanProgress">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <span class="progress-phase" id="progressPhase">Scanning</span>
                    <span class="progress-count" id="progressCount">0/0</span>
                </div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
                </div>
                <div class="progress-info">
                    <span class="progress-subject" id="progressSubject"></span>
                    <div class="progress-stats" id="progressStats"></div>
                </div>
            </div>

            <div class="classifier-notice" id="classifierNotice"></div>

            <div class="table-card">
                <div class="table-toolbar">
                    <div class="toolbar-top">
                        <div class="filter-pills">
                            <button class="filter-pill active" id="pillReview" onclick="setPendingFilter('pending_review')">For Review <span class="pill-count" id="pillReviewCount">0</span></button>
                            <button class="filter-pill" id="pillOos" onclick="setPendingFilter('out_of_scope')">Out of Scope <span class="pill-count" id="pillOosCount">0</span></button>
                            <button class="filter-pill" id="pillRejected" onclick="setPendingFilter('rejected')">Rejected <span class="pill-count" id="pillRejectedCount">0</span></button>
                        </div>
                        <div class="toolbar-controls">
                            <div class="bulk-bar" id="bulkActions" style="display:none">
                                <span class="bulk-count" id="bulkCount">0</span>
                                <button class="btn btn-success btn-sm" onclick="bulkApprove()">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="bulkReject()">Reject</button>
                            </div>
                            <button class="view-toggle desktop-only" id="pendingViewToggle" onclick="toggleView('pending')">Expanded</button>
                        </div>
                    </div>
                    <input class="search-box" id="pendingSearch" type="text" placeholder="Filter emails..." oninput="filterPending()">
                </div>
                <div id="pendingTableWrap">
                    <div class="empty-state">No emails pending review. Click "Scan Now" to check.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROCESSED -->
    <div class="tab-panel" id="tab-processed">
        <div class="container">
            <div class="stats-row">
                <div class="stat-card"><div class="label">Total</div><div class="value" id="statTotal">--</div></div>
                <div class="stat-card"><div class="label">Today</div><div class="value" id="statToday">--</div></div>
                <div class="stat-card"><div class="label">With Att.</div><div class="value" id="statAttach">--</div></div>
            </div>
            <div class="table-card">
                <div class="table-toolbar">
                    <div class="toolbar-top">
                        <h2>Recent Processed</h2>
                        <div class="toolbar-controls">
                            <a class="btn btn-success btn-sm" href="/api/export/excel" download style="text-decoration:none;margin-right:6px">Export Excel</a>
                            <button class="view-toggle desktop-only" id="processedViewToggle" onclick="toggleView('processed')">Expanded</button>
                        </div>
                    </div>
                    <input class="search-box" id="processedSearch" type="text" placeholder="Search processed..." oninput="debouncedSearchProcessed()">
                </div>
                <div id="emailTableWrap"><div class="empty-state">No emails processed yet.</div></div>
            </div>
            <div class="log-panel">
                <div class="log-header" onclick="toggleLog()">
                    <h2>Activity Log</h2><span class="toggle" id="logToggle">+</span>
                </div>
                <div class="log-body" id="logBody"></div>
            </div>
        </div>
    </div>

    <!-- DEPARTMENTS -->
    <div class="tab-panel" id="tab-departments">
        <div class="container">
            <div class="table-card">
                <div class="table-toolbar"><div class="toolbar-top"><h2>Departments</h2></div></div>
                <div class="add-form">
                    <div class="form-row">
                        <div class="form-group" style="max-width:180px"><label>Name</label><input type="text" id="deptName" placeholder="e.g. MEP"></div>
                        <div class="form-group"><label>Keywords (comma-separated)</label><input type="text" id="deptKeywords" placeholder="e.g. mechanical, plumbing"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Description / Scope</label><input type="text" id="deptDescription" placeholder="Describe what this department handles..."></div>
                    </div>
                    <button class="btn btn-primary" onclick="addDepartment()" style="align-self:flex-end">Add Department</button>
                </div>
                <div id="deptTableWrap"><div class="empty-state">No departments configured.</div></div>
            </div>
        </div>
    </div>

    <!-- CONTACTS -->
    <div class="tab-panel" id="tab-contacts">
        <div class="container">
            <div class="table-card">
                <div class="table-toolbar"><div class="toolbar-top"><h2>Expected Senders</h2></div></div>
                <div class="add-form">
                    <div class="form-row">
                        <div class="form-group"><label>Name</label><input type="text" id="contactName" placeholder="e.g. John Smith"></div>
                        <div class="form-group"><label>Email</label><input type="text" id="contactEmail" placeholder="e.g. john@co.com"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Company</label><input type="text" id="contactCompany" placeholder="e.g. AECOM"></div>
                        <div class="form-group"><label>Dept.</label><input type="text" id="contactDept" placeholder="e.g. Eng."></div>
                        <div class="form-group"><label>Notes</label><input type="text" id="contactNotes" placeholder="Optional"></div>
                    </div>
                    <button class="btn btn-primary" onclick="addContact()" style="align-self:flex-end">Add Contact</button>
                </div>
                <div id="contactTableWrap"><div class="empty-state">No contacts added yet.</div></div>
            </div>
        </div>
    </div>

<script>
// ---- State ----
var classificationOptions = { doc_types: [], disciplines: [], departments: [] };
var pendingEmails = [];
var processedEmails = [];
var selectedIds = new Set();
var pendingStatusFilter = 'pending_review';
var viewModes = { pending: 'compact', processed: 'compact' };
var currentModalId = null;
var modalBodyFull = '', modalBodySummary = '', modalBodyHtml = '', showingFullBody = false, currentBodyView = 'text';
var pendingPage = 0, processedPage = 0;
var PAGE_SIZE = 15;
var isMobile = window.innerWidth < 768;
window.addEventListener('resize', function(){ isMobile = window.innerWidth < 768; });

// ---- Helpers ----
function esc(s) { if(!s) return ''; var el=document.createElement('span'); el.textContent=s; return el.innerHTML; }
function fmtTime(iso) {
    if(!iso) return '--';
    var d=new Date(iso), dd=d.getDate(),
    mm=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()],
    hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
    return dd+' '+mm+' '+hh+':'+mi;
}
function showToast(msg,type) {
    type=type||'info'; var c=document.getElementById('toastContainer');
    var t=document.createElement('div'); t.className='toast toast-'+type; t.textContent=msg;
    c.appendChild(t); setTimeout(function(){t.remove();},4000);
}
function makeOptions(vals,sel) {
    return vals.map(function(v){return '<option value="'+esc(v)+'"'+(v===sel?' selected':'')+'>'+esc(v)+'</option>';}).join('');
}
function fmtRecipients(jsonStr) {
    var arr; try{arr=JSON.parse(jsonStr||'[]');}catch(e){return esc(jsonStr||'');}
    if(!Array.isArray(arr)||!arr.length) return '<span style="color:var(--text-light)">--</span>';
    return arr.map(function(r){
        if(typeof r==='string') return esc(r);
        var n=(r.name||'').trim(), e2=(r.email||'').trim();
        if(n&&e2) return esc(n+' <'+e2+'>'); return esc(n||e2);
    }).join(', ');
}
function fmtFileSize(b) {
    if(!b||b===0) return ''; if(b<1024) return b+' B';
    if(b<1048576) return (b/1024).toFixed(0)+' KB'; return (b/1048576).toFixed(1)+' MB';
}

// ---- AI Badge Helper ----
function renderAiBadge(method, confidence) {
    if (!method) return '';
    var pct = confidence != null ? Math.round(confidence * 100) : null;
    var cls = 'conf-none';
    if (pct !== null) {
        if (pct >= 80) cls = 'conf-high';
        else if (pct >= 50) cls = 'conf-mid';
        else cls = 'conf-low';
    }
    var label = esc(method);
    if (pct !== null) label += ' \u00b7 ' + pct + '%';
    return '<span class="ai-badge ' + cls + '"><span class="ai-dot"></span>' + label + '</span>';
}

function renderThreadBadges(e) {
    var html = '';
    var tc = e.thread_count || 0;
    var pos = e.conversation_position || 1;
    if (tc > 1) {
        html += '<span class="thread-badge thread-count">' + tc + ' in thread</span>';
    }
    if (pos === 1) {
        html += '<span class="thread-badge new-topic">New</span>';
    } else if (pos > 1) {
        html += '<span class="thread-badge follow-up">Follow-up</span>';
    }
    if (e.transmittal_no && e.status === 'approved' && pos > 1) {
        html += '<span class="thread-badge auto-assigned">Auto: ' + esc(e.transmittal_no) + '</span>';
    }
    return html;
}

// ---- Dark Mode (F6) ----
function toggleDarkMode() {
    var html = document.documentElement;
    var isDark = html.getAttribute('data-theme') === 'dark';
    if (isDark) {
        html.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
    } else {
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
    }
    updateDarkToggleIcon();
}
function updateDarkToggleIcon() {
    var btn = document.getElementById('darkToggle');
    if (!btn) return;
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    btn.innerHTML = isDark ? '&#9788;' : '&#9790;';
    btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
}
updateDarkToggleIcon();

// ---- Debounced Server Search (F4) ----
var _searchTimer = null;
function debouncedSearchProcessed() {
    if (_searchTimer) clearTimeout(_searchTimer);
    _searchTimer = setTimeout(function() { fetchEmails(0); }, 400);
}

// ---- Pagination ----
function paginate(items, page) {
    var start = page * PAGE_SIZE;
    return { items: items.slice(start, start + PAGE_SIZE), total: items.length, page: page, pages: Math.ceil(items.length / PAGE_SIZE) };
}
function renderPagination(totalItems, currentPage, onPageFn) {
    var pages = Math.ceil(totalItems / PAGE_SIZE);
    if (pages <= 1) return '';
    var from = currentPage*PAGE_SIZE+1, to = Math.min((currentPage+1)*PAGE_SIZE, totalItems);
    var html = '<div class="table-footer"><span>'+from+'-'+to+' of '+totalItems+'</span><div class="pagination">';
    html += '<button class="page-btn" onclick="'+onPageFn+'('+(currentPage-1)+')"'+(currentPage===0?' disabled':'')+'>&laquo;</button>';
    // Show max 5 page buttons on mobile
    var maxBtns = isMobile ? 5 : pages;
    var startP = Math.max(0, currentPage - Math.floor(maxBtns/2));
    var endP = Math.min(pages, startP + maxBtns);
    if(endP - startP < maxBtns) startP = Math.max(0, endP - maxBtns);
    for (var i=startP; i<endP; i++) {
        html += '<button class="page-btn'+(i===currentPage?' active':'')+'" onclick="'+onPageFn+'('+i+')">'+(i+1)+'</button>';
    }
    html += '<button class="page-btn" onclick="'+onPageFn+'('+(currentPage+1)+')"'+(currentPage>=pages-1?' disabled':'')+'>&raquo;</button>';
    html += '</div></div>';
    return html;
}

// ---- View Toggle ----
function toggleView(t) {
    var btn=document.getElementById(t+'ViewToggle');
    if(viewModes[t]==='compact'){viewModes[t]='expanded';btn.classList.add('expanded');btn.textContent='Compact';}
    else{viewModes[t]='compact';btn.classList.remove('expanded');btn.textContent='Expanded';}
    if(t==='pending') renderPendingTable();
    if(t==='processed') renderProcessedTable();
}

// ---- Tabs ----
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');});
    document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
    document.querySelector('[data-tab="'+tab+'"]').classList.add('active');
    document.getElementById('tab-'+tab).classList.add('active');
    if(tab==='home') fetchHomeStats();
    if(tab==='review') fetchPending();
    if(tab==='processed'){fetchEmails();fetchStatus();}
    if(tab==='departments') fetchDepartments();
    if(tab==='contacts') fetchContacts();
}

// ---- Scanner ----
function updateStatus(data) {
    var dot=document.getElementById('headerDot'), hdr=document.getElementById('headerStatus');
    dot.className='status-dot '+data.status;
    var labels={idle:'Idle',scanning:'Scanning...',error:'Error'};
    hdr.textContent=labels[data.status]||data.status;
    document.getElementById('scanStatus').textContent=labels[data.status]||data.status;
    document.getElementById('scanLast').textContent=fmtTime(data.last_scan_time);
    document.getElementById('scanNext').textContent=fmtTime(data.next_scan_time);
    var sr=document.getElementById('scanResult');
    if(data.last_scan_result){sr.textContent=data.last_scan_result;sr.className='ctrl-value '+(data.last_scan_ok?'ok':'err');}
    var btn=document.getElementById('btnScan');
    var btnAll=document.getElementById('btnScanAll');
    var btnReclass=document.getElementById('btnReclassify');
    if(data.status==='scanning'){btn.disabled=true;btn.textContent='Scanning...';if(btnAll)btnAll.disabled=true;if(btnReclass)btnReclass.disabled=true;}
    else{btn.disabled=false;btn.textContent='Scan Now';if(btnAll){btnAll.disabled=false;btnAll.textContent='Scan All Emails';}if(btnReclass){btnReclass.disabled=false;btnReclass.textContent='Re-classify';}}
    // F2: Classifier downgrade notice
    var notice = document.getElementById('classifierNotice');
    if (notice && data.classifiers_used && data.classifiers_used.length > 0) {
        fetch('/api/classifier-info').then(function(r){return r.json();}).then(function(info){
            var configured = info.method;
            var used = data.classifiers_used;
            var downgraded = false;
            var usedNames = used.join(', ');
            if (configured !== 'rule_based') {
                for (var i = 0; i < used.length; i++) {
                    if (used[i] === 'rule_based' || (configured !== 'auto' && used[i] !== configured)) {
                        downgraded = true; break;
                    }
                }
            }
            if (downgraded) {
                notice.textContent = 'Last scan used: ' + usedNames + ' (configured: ' + info.active_label + ')';
                notice.style.display = 'block';
            } else {
                notice.style.display = 'none';
            }
        }).catch(function(){ notice.style.display = 'none'; });
    } else if (notice) {
        notice.style.display = 'none';
    }
}
function fetchStatus(){fetch('/api/status').then(function(r){return r.json();}).then(updateStatus).catch(function(){});}
function triggerScan() {
    var btn=document.getElementById('btnScan'); btn.disabled=true; btn.textContent='Starting...';
    fetch('/api/scan',{method:'POST'}).then(function(r){
        if(r.status===409){btn.textContent='Already running';setTimeout(function(){btn.disabled=false;btn.textContent='Scan Now';},2000);return;}
        startScanPolling();
    }).catch(function(){btn.disabled=false;btn.textContent='Scan Now';});
}
function triggerScanAll() {
    if(!confirm('This will scan ALL emails in your inbox (read + unread). It may take several minutes. Continue?')) return;
    var btn=document.getElementById('btnScanAll'); btn.disabled=true; btn.textContent='Scanning all...';
    var btnMain=document.getElementById('btnScan'); btnMain.disabled=true;
    fetch('/api/scan-all',{method:'POST'}).then(function(r){
        if(r.status===409){btn.textContent='Already running';setTimeout(function(){btn.disabled=false;btn.textContent='Scan All Emails';btnMain.disabled=false;},2000);return;}
        showToast('Full inbox scan started  this may take a few minutes','info');
        startScanPolling();
    }).catch(function(){btn.disabled=false;btn.textContent='Scan All Emails';btnMain.disabled=false;});
}
function triggerReclassify() {
    var includeOOS=confirm('Re-classify all pending emails using current departments, contacts, and rules.\n\nAlso include out-of-scope emails? (OK = Yes, Cancel = pending only)');
    var btn=document.getElementById('btnReclassify'); btn.disabled=true; btn.textContent='Re-classifying...';
    var btnMain=document.getElementById('btnScan'); btnMain.disabled=true;
    var btnAll=document.getElementById('btnScanAll'); if(btnAll)btnAll.disabled=true;
    fetch('/api/reclassify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({include_out_of_scope:includeOOS})}).then(function(r){
        if(r.status===409){btn.textContent='Already running';setTimeout(function(){btn.disabled=false;btn.textContent='Re-classify';btnMain.disabled=false;if(btnAll)btnAll.disabled=false;},2000);return;}
        showToast('Re-classification started','info');
        startScanPolling();
    }).catch(function(){btn.disabled=false;btn.textContent='Re-classify';btnMain.disabled=false;if(btnAll)btnAll.disabled=false;});
}
var scanPollTimer=null;
function startScanPolling(){
    if(scanPollTimer)clearInterval(scanPollTimer);
    scanPollTimer=setInterval(function(){
        fetch('/api/status').then(function(r){return r.json();}).then(function(d){
            updateStatus(d);
            if(d.status!=='scanning'){
                clearInterval(scanPollTimer);scanPollTimer=null;fetchPending();fetchEmails(0);
                // Hide progress bar after 2 seconds
                setTimeout(function(){
                    var el=document.getElementById('scanProgress');
                    if(el) el.classList.remove('active');
                },2000);
            }
        }).catch(function(){});
        // Also poll scan progress
        fetch('/api/scan-progress').then(function(r){return r.json();}).then(updateScanProgress).catch(function(){});
    },2000);
}
function updateScanProgress(p){
    var el=document.getElementById('scanProgress');
    if(!el)return;
    if(p.active){
        el.classList.add('active');
        var pct=p.total>0?Math.round((p.scanned/p.total)*100):0;
        document.getElementById('progressBar').style.width=pct+'%';
        document.getElementById('progressCount').textContent=p.scanned+'/'+p.total;
        document.getElementById('progressPhase').textContent=p.phase||'Scanning';
        var subj=p.current_subject||'';
        if(subj.length>60) subj=subj.substring(0,57)+'...';
        document.getElementById('progressSubject').textContent=subj;
        var stats='';
        if(p.queued) stats+='<span>Queued: '+p.queued+'</span>';
        if(p.inherited) stats+='<span>Inherited: '+p.inherited+'</span>';
        if(p.auto_assigned) stats+='<span>Auto: '+p.auto_assigned+'</span>';
        if(p.out_of_scope) stats+='<span>OOS: '+p.out_of_scope+'</span>';
        if(p.skipped) stats+='<span>Skipped: '+p.skipped+'</span>';
        if(p.already_known) stats+='<span>Known: '+p.already_known+'</span>';
        if(p.errors) stats+='<span style="color:var(--danger)">Errors: '+p.errors+'</span>';
        document.getElementById('progressStats').innerHTML=stats;
    } else {
        // Keep showing final state briefly, then hide
    }
}

// ---- Review Queue ----
function setPendingFilter(status) {
    pendingStatusFilter = status;
    selectedIds.clear();
    document.querySelectorAll('.filter-pill').forEach(function(p){ p.classList.remove('active'); });
    var pillMap = { 'pending_review': 'pillReview', 'out_of_scope': 'pillOos', 'rejected': 'pillRejected' };
    var pill = document.getElementById(pillMap[status]);
    if (pill) pill.classList.add('active');
    // Show/hide bulk actions based on filter
    var bulkBar = document.getElementById('bulkActions');
    if (bulkBar) bulkBar.style.display = 'none';
    fetchPending();
}
function updatePillCounts(stats) {
    var pills = [
        { id: 'pillReviewCount', key: 'pending_review' },
        { id: 'pillOosCount', key: 'out_of_scope' },
        { id: 'pillRejectedCount', key: 'rejected' },
    ];
    pills.forEach(function(p) {
        var el = document.getElementById(p.id);
        var count = stats[p.key] || 0;
        if (el) el.textContent = count;
        var pill = el ? el.parentElement : null;
        if (pill) {
            if (count > 0) pill.classList.add('has-count');
            else pill.classList.remove('has-count');
        }
    });
}
function fetchPending() {
    fetch('/api/pending?status=' + encodeURIComponent(pendingStatusFilter)).then(function(r){return r.json();}).then(function(data){
        pendingEmails=data.emails||[];
        var stats=data.stats||{}, count=stats.pending_review||0;
        var badge=document.getElementById('pendingBadge');
        badge.textContent=count; badge.className='tab-badge'+(count===0?' zero':'');
        updatePillCounts(stats);
        pendingPage=0; renderPendingTable();
    }).catch(function(){});
}
function getFilteredPending() {
    var q=(document.getElementById('pendingSearch').value||'').toLowerCase().trim();
    if(!q) return pendingEmails;
    return pendingEmails.filter(function(e){
        return (e.subject||'').toLowerCase().indexOf(q)>=0 ||
               (e.sender||'').toLowerCase().indexOf(q)>=0 ||
               (e.sender_name||'').toLowerCase().indexOf(q)>=0 ||
               (e.doc_type||'').toLowerCase().indexOf(q)>=0;
    });
}
function filterPending() { pendingPage=0; renderPendingTable(); }
function setPendingPage(p) { pendingPage=p; renderPendingTable(); }

function renderPendingTable() {
    var wrap=document.getElementById('pendingTableWrap');
    var filtered=getFilteredPending();
    var isReview = pendingStatusFilter === 'pending_review';
    var isOos = pendingStatusFilter === 'out_of_scope';
    var isRejected = pendingStatusFilter === 'rejected';
    var emptyMsg = isReview ? 'No emails pending review. Click "Scan Now" to check.'
                 : isOos ? 'No out-of-scope emails found.'
                 : 'No rejected emails.';
    if(!filtered.length){
        wrap.innerHTML='<div class="empty-state">'+(pendingEmails.length?'No matches found.':emptyMsg)+'</div>';
        document.getElementById('bulkActions').style.display='none'; return;
    }
    var pg=paginate(filtered, pendingPage);
    var html = '';

    // Mobile card layout
    html += '<div class="email-cards">';
    for(var i=0;i<pg.items.length;i++){
        var e=pg.items[i];
        var checked=selectedIds.has(e.id)?' checked':'';
        var senderBadge=e.sender_known?'<span class="sender-known">Known</span>':'<span class="sender-unknown">New</span>';
        html+='<div class="email-card">';
        html+='<div class="card-row">';
        if(isReview) html+='<div class="card-check"><input type="checkbox" data-id="'+e.id+'"'+checked+' onchange="onRowSelect()"></div>';
        html+='<div style="flex:1;min-width:0">';
        html+='<div class="card-subject" onclick="openDetailModal('+e.id+')">'+esc(e.subject||'(no subject)')+renderThreadBadges(e)+'</div>';
        if(e.ai_summary) html+='<div class="card-summary">'+esc(e.ai_summary.substring(0,100))+'</div>';
        html+='<div class="card-meta">';
        html+='<span>'+esc(e.sender_name||e.sender)+senderBadge+'</span>';
        html+='<span>'+fmtTime(isRejected && e.decided_at ? e.decided_at : e.scanned_at)+'</span>';
        if(isReview && e.attachment_count) html+='<span>'+e.attachment_count+' att.</span>';
        html+='</div>';
        html+='</div></div>';
        html+='<div class="card-row">';
        html+='<div class="card-tags">';
        if(e.doc_type) html+='<span class="card-tag">'+esc(e.doc_type)+'</span>';
        if(e.discipline) html+='<span class="card-tag">'+esc(e.discipline)+'</span>';
        if(e.department) html+='<span class="card-tag">'+esc(e.department)+'</span>';
        html+=renderAiBadge(e.classifier_method, e.confidence);
        html+='</div>';
        html+='<div class="card-actions">';
        if(isReview){
            if(e.confidence>=0.8 && e.classifier_method && e.classifier_method!=='Keywords'){
                html+='<button class="btn-quick-approve" onclick="approveOne('+e.id+')">&#10003; Quick Approve</button>';
            } else {
                html+='<button class="btn btn-primary btn-sm" onclick="openDetailModal('+e.id+')">Review</button>';
            }
            html+='<button class="btn btn-danger btn-sm" onclick="rejectOne('+e.id+')">Reject</button>';
        } else if(isOos){
            html+='<button class="btn-move-review" onclick="moveToReview('+e.id+')">Move to Review</button>';
        } else if(isRejected){
            html+='<button class="btn-reopen" onclick="reopenRejected('+e.id+')">Reopen</button>';
        }
        html+='</div></div></div>';
    }
    html += '</div>';

    // Desktop table layout
    var exp=viewModes.pending==='expanded'?' table-expanded':'';
    html+='<div class="table-wrap"><table class="'+exp+'"><thead><tr>';
    if(isReview) html+='<th style="width:30px"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>';
    html+='<th style="width:30px">#</th><th>Date</th><th>From</th><th>Subject</th>';
    if(isReview) html+='<th>Att.</th><th>Type</th><th>Discipline</th><th>Dept.</th>';
    html+='<th>AI</th>';
    html+='<th>Actions</th>';
    html+='</tr></thead><tbody>';
    for(var i=0;i<pg.items.length;i++){
        var e=pg.items[i], idx=pg.page*PAGE_SIZE+i+1;
        var checked=selectedIds.has(e.id)?' checked':'';
        var senderBadge=e.sender_known?'<span class="sender-known">Known</span>':'<span class="sender-unknown">Unknown</span>';
        var senderCompany=e.sender_company?'<span class="sender-company">'+esc(e.sender_company)+'</span>':'';
        var dateCol = isRejected && e.decided_at ? e.decided_at : e.scanned_at;
        html+='<tr>';
        if(isReview) html+='<td><input type="checkbox" data-id="'+e.id+'"'+checked+' onchange="onRowSelect()"></td>';
        html+='<td class="col-num">'+idx+'</td>'+
            '<td style="white-space:nowrap">'+fmtTime(dateCol)+'</td>'+
            '<td class="col-sender" title="'+esc(e.sender)+'">'+esc(e.sender_name||e.sender)+senderBadge+senderCompany+'</td>'+
            '<td class="col-subject"><span class="subject-link" onclick="openDetailModal('+e.id+')">'+esc(e.subject)+'</span>'+renderThreadBadges(e)+'</td>';
        if(isReview){
            html+='<td id="att-cell-'+e.id+'">'+(e.attachment_count||0)+'</td>'+
                '<td><select class="inline-select" data-id="'+e.id+'" data-field="doc_type">'+makeOptions(classificationOptions.doc_types,e.doc_type)+'</select></td>'+
                '<td><select class="inline-select" data-id="'+e.id+'" data-field="discipline">'+makeOptions(classificationOptions.disciplines,e.discipline)+'</select></td>'+
                '<td><select class="inline-select" data-id="'+e.id+'" data-field="department"><option value="">--</option>'+makeOptions(classificationOptions.departments,e.department)+'</select></td>';
        }
        html+='<td>'+renderAiBadge(e.classifier_method, e.confidence)+'</td>';
        if(isReview){
            html+='<td class="col-actions"><div class="row-actions">';
            if(e.confidence>=0.8 && e.classifier_method && e.classifier_method!=='Keywords'){
                html+='<button class="btn-quick-approve" onclick="approveOne('+e.id+')">&#10003; Approve</button>';
            } else {
                html+='<button class="btn btn-success btn-sm" onclick="approveOne('+e.id+')">Approve</button>';
            }
            html+='<button class="btn btn-danger btn-sm" onclick="rejectOne('+e.id+')">Reject</button>';
            html+='</div></td>';
        } else if(isOos){
            html+='<td class="col-actions"><button class="btn-move-review" onclick="moveToReview('+e.id+')">Move to Review</button></td>';
        } else if(isRejected){
            html+='<td class="col-actions"><button class="btn-reopen" onclick="reopenRejected('+e.id+')">Reopen</button></td>';
        }
        html+='</tr>';
    }
    html+='</tbody></table></div>';
    html+=renderPagination(filtered.length,pendingPage,'setPendingPage');
    wrap.innerHTML=html;
    if(isReview) updateBulkBar();
    else document.getElementById('bulkActions').style.display='none';
    // Fetch attachment details for desktop view (only for review status)
    if(isReview){
        pg.items.forEach(function(e){
            if(e.attachment_count>0){
                fetch('/api/pending/'+e.id+'/attachments').then(function(r){return r.json();}).then(function(data){
                    var cell=document.getElementById('att-cell-'+e.id);
                    if(!cell||!data.attachments||!data.attachments.length) return;
                    var links='<div class="att-list">';
                    data.attachments.forEach(function(att){
                        var sz=fmtFileSize(att.size), sc=att.is_signature?' att-signature':'', st=att.is_signature?'<span class="tag-signature">Sig</span>':'';
                        links+='<a href="/api/pending/'+e.id+'/attachments/'+att.id+'" target="_blank" title="'+esc(att.filename)+'" class="'+sc+'">'+esc(att.filename)+(sz?'<span class="att-size">('+sz+')</span>':'')+'</a>'+st;
                    }); links+='</div>'; cell.innerHTML=links;
                }).catch(function(){});
            }
        });
    }
}
function toggleSelectAll(){
    var ch=document.getElementById('selectAll');
    if(!ch)return; ch=ch.checked;
    document.querySelectorAll('#pendingTableWrap input[type="checkbox"][data-id]').forEach(function(cb){
        cb.checked=ch; var id=parseInt(cb.dataset.id); if(ch)selectedIds.add(id);else selectedIds.delete(id);
    }); updateBulkBar();
}
function onRowSelect(){
    selectedIds.clear();
    document.querySelectorAll('#pendingTableWrap input[type="checkbox"][data-id]:checked').forEach(function(cb){selectedIds.add(parseInt(cb.dataset.id));});
    updateBulkBar();
}
function updateBulkBar(){
    var bar=document.getElementById('bulkActions'),cnt=document.getElementById('bulkCount');
    if(selectedIds.size>0){bar.style.display='flex';cnt.textContent=selectedIds.size+' selected';}
    else{bar.style.display='none';}
}
function getEditsForRow(id){
    var edits={};
    document.querySelectorAll('select.inline-select[data-id="'+id+'"]').forEach(function(s){edits[s.dataset.field]=s.value;});
    return edits;
}
function approveOne(id){
    var edits=getEditsForRow(id);
    fetch('/api/pending/'+id+'/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(edits)})
    .then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Approved: '+d.transmittal_no,'success'); selectedIds.delete(id); fetchPending(); fetchEmails();
    }).catch(function(){showToast('Approve failed','error');});
}
function rejectOne(id){
    fetch('/api/pending/'+id+'/reject',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Rejected','info'); selectedIds.delete(id); fetchPending();
    }).catch(function(){showToast('Reject failed','error');});
}
function bulkApprove(){
    var ids=Array.from(selectedIds); if(!ids.length)return;
    fetch('/api/pending/bulk-approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:ids})})
    .then(function(r){return r.json();}).then(function(d){
        if(d.approved&&d.approved.length) showToast('Approved '+d.approved.length,'success');
        if(d.errors&&d.errors.length) showToast(d.errors.length+' failed','error');
        selectedIds.clear(); fetchPending(); fetchEmails();
    }).catch(function(){showToast('Bulk approve failed','error');});
}
function bulkReject(){
    var ids=Array.from(selectedIds); if(!ids.length)return;
    fetch('/api/pending/bulk-reject',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:ids})})
    .then(function(r){return r.json();}).then(function(d){
        if(d.rejected&&d.rejected.length) showToast('Rejected '+d.rejected.length,'info');
        selectedIds.clear(); fetchPending();
    }).catch(function(){showToast('Bulk reject failed','error');});
}

function moveToReview(id){
    fetch('/api/pending/'+id+'/move-to-review',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Moved to review queue','success'); fetchPending();
    }).catch(function(){showToast('Move failed','error');});
}

function reopenRejected(id){
    fetch('/api/pending/'+id+'/reopen',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Reopened for review','success'); fetchPending();
    }).catch(function(){showToast('Reopen failed','error');});
}

// ---- Detail Modal ----
function openDetailModal(id){
    currentModalId=id;
    document.getElementById('modalSubject').textContent='Loading...';
    document.getElementById('modalBody').innerHTML='<div class="empty-state">Loading...</div>';
    // Update modal footer buttons based on current filter
    var footer=document.getElementById('modalFooter');
    if(pendingStatusFilter==='out_of_scope'){
        footer.innerHTML='<button class="btn btn-ghost" onclick="closeDetailModal()">Close</button>'+
            '<button class="btn-move-review" style="padding:10px 20px;font-size:14px;flex:1" onclick="modalMoveToReview()">Move to Review</button>';
    } else if(pendingStatusFilter==='rejected'){
        footer.innerHTML='<button class="btn btn-ghost" onclick="closeDetailModal()">Close</button>'+
            '<button class="btn-reopen" style="padding:10px 20px;font-size:14px;flex:1" onclick="modalReopenRejected()">Reopen</button>';
    } else {
        footer.innerHTML='<button class="btn btn-ghost" onclick="closeDetailModal()">Close</button>'+
            '<button class="btn btn-danger" onclick="modalReject()">Reject</button>'+
            '<button class="btn btn-success" onclick="modalApprove()">Approve</button>';
    }
    document.getElementById('detailModal').classList.add('open');
    document.body.style.overflow='hidden';
    fetch('/api/pending/'+id+'/detail').then(function(r){return r.json();}).then(function(e){
        if(e.error){document.getElementById('modalBody').innerHTML='<div class="empty-state">'+esc(e.error)+'</div>';return;}
        document.getElementById('modalSubject').textContent=e.subject||'(no subject)';
        var to=fmtRecipients(e.to_recipients), cc=fmtRecipients(e.cc_recipients);
        var h='';
        h+='<div class="modal-fields-row">';
        h+='<div class="modal-field"><div class="modal-field-label">From</div><div class="modal-field-value">'+esc(e.sender_name||e.sender);
        h+=(e.sender_known?' <span class="sender-known">Known</span>':' <span class="sender-unknown">Unknown</span>');
        if(e.sender_company) h+='<span class="sender-company">'+esc(e.sender_company)+'</span>';
        h+='</div></div>';
        h+='<div class="modal-field"><div class="modal-field-label">Date</div><div class="modal-field-value">'+fmtTime(e.email_date||e.scanned_at)+'</div></div>';
        h+='</div>';
        h+='<div class="modal-fields-row">';
        h+='<div class="modal-field"><div class="modal-field-label">To</div><div class="modal-field-value">'+to+'</div></div>';
        h+='<div class="modal-field"><div class="modal-field-label">CC</div><div class="modal-field-value">'+cc+'</div></div>';
        h+='</div>';
        var summary=e.body_summary||'', full=e.body||'';
        modalBodySummary=summary; modalBodyFull=full; showingFullBody=false;
        modalBodyHtml=e.body_html||''; currentBodyView='text';
        h+='<div class="modal-field"><div class="modal-field-label">Body</div>';
        if(modalBodyHtml){
            h+='<div class="body-view-toggle"><button class="body-view-btn active" id="btnViewText" onclick="switchBodyView(\'text\')">Text</button><button class="body-view-btn" id="btnViewHtml" onclick="switchBodyView(\'html\')">HTML</button></div>';
        }
        h+='<div id="bodyTextWrap">';
        if(summary){
            h+='<div class="modal-body-text" id="modalBodyText">'+esc(summary)+'</div>';
            if(full.length>summary.length) h+='<span class="body-toggle" id="bodyToggle" onclick="toggleFullBody()">Show full body</span>';
        } else {
            h+='<div class="modal-body-text" id="modalBodyText">'+esc(full||'(no body)')+'</div>';
        }
        h+='</div>';
        h+='<div id="bodyHtmlWrap" style="display:none"><iframe class="modal-body-html" id="bodyHtmlFrame" sandbox="allow-same-origin" srcdoc=""></iframe></div>';
        h+='</div>';
        var atts=e.attachments||[];
        if(atts.length){
            h+='<div class="modal-field"><div class="modal-field-label">Attachments ('+atts.length+')</div><div class="modal-att-list">';
            atts.forEach(function(a){
                var sc=a.is_signature?' signature':'', st=a.is_signature?' <span class="tag-signature">Signature</span>':'';
                h+='<div class="modal-att-item'+sc+'"><a href="/api/pending/'+id+'/attachments/'+a.id+'" target="_blank">'+esc(a.filename)+'</a><span class="att-size">'+fmtFileSize(a.size)+'</span>'+st+'</div>';
            }); h+='</div></div>';
        }
        if(e.classifier_method){
            h+='<div class="modal-field"><div class="modal-field-label">Classified By</div><div class="modal-field-value">'+renderAiBadge(e.classifier_method, e.confidence)+'</div></div>';
        }
        // AI Assistant Panel (Feature 4)
        if(e.ai_summary || e.ai_priority){
            var pri=e.ai_priority||'medium';
            var priClass='priority-'+pri;
            var priLabel=pri.charAt(0).toUpperCase()+pri.slice(1);
            h+='<div class="ai-assistant-panel">';
            h+='<div class="ai-panel-title">&#9733; AI Assistant</div>';
            if(e.ai_summary) h+='<div class="ai-panel-summary">'+esc(e.ai_summary)+'</div>';
            h+='<div class="ai-panel-row">';
            h+='<span class="priority-badge '+priClass+'">Priority: '+priLabel+'</span>';
            if(e.confidence>=0.8 && e.department){
                h+='<span class="ai-suggestion">Suggested: <span class="suggest-action">Approve &rarr; '+esc(e.department)+'</span></span>';
            } else {
                h+='<span class="ai-suggestion"><span class="suggest-review">Review carefully</span>  confidence '+((e.confidence||0)*100).toFixed(0)+'%</span>';
            }
            h+='</div></div>';
        }
        // Conversation timeline
        if(e.thread_emails && e.thread_emails.length > 1){
            h+='<div class="modal-field"><div class="modal-field-label">Conversation Thread ('+e.thread_emails.length+' emails)</div>';
            if(e.conversation && e.conversation.transmittal_no){
                h+='<div style="font-size:12px;margin-bottom:8px;color:var(--primary);font-weight:600">'+esc(e.conversation.transmittal_no)+'</div>';
            }
            h+='<div class="conv-timeline">';
            for(var ti=0;ti<e.thread_emails.length;ti++){
                var te=e.thread_emails[ti];
                var isCurrent = te.message_id === e.message_id;
                var tlClass = isCurrent ? 'conv-timeline-item current' : 'conv-timeline-item';
                var clickable = (!isCurrent && te.id && te.source === 'pending') ? ' conv-timeline-link' : '';
                h+='<div class="'+tlClass+clickable+'"'+(clickable?' onclick="closeDetailModal();setTimeout(function(){openDetailModal('+te.id+')},200)"':'')+'>';
                h+='<span class="tl-date">'+fmtTime(te.email_date)+'</span>';
                h+='<span class="tl-sender">'+esc(te.sender_name||te.sender)+'</span>';
                h+=' &mdash; <span class="tl-subject">'+esc(te.subject||'(no subject)')+'</span>';
                if(te.transmittal_no){
                    var stCls = (te.status==='approved' && te.conversation_position > 1) ? 'auto' : 'approved';
                    h+='<span class="tl-status '+stCls+'">'+esc(te.transmittal_no)+'</span>';
                } else if(te.status==='pending_review'){
                    h+='<span class="tl-status pending">Pending</span>';
                }
                if(isCurrent) h+=' <span style="font-size:10px;color:var(--primary)">&larr; current</span>';
                h+='</div>';
            }
            h+='</div></div>';
        }
        if(pendingStatusFilter==='pending_review'){
            h+='<div class="modal-fields-row">';
            h+='<div class="modal-field"><div class="modal-field-label">Document Type</div><select class="modal-select" id="modalDocType">'+makeOptions(classificationOptions.doc_types,e.doc_type)+'</select></div>';
            h+='<div class="modal-field"><div class="modal-field-label">Discipline</div><select class="modal-select" id="modalDiscipline">'+makeOptions(classificationOptions.disciplines,e.discipline)+'</select></div>';
            h+='<div class="modal-field"><div class="modal-field-label">Department</div><select class="modal-select" id="modalDepartment"><option value="">--</option>'+makeOptions(classificationOptions.departments,e.department)+'</select></div>';
            h+='</div>';
        }
        document.getElementById('modalBody').innerHTML=h;
    }).catch(function(){document.getElementById('modalBody').innerHTML='<div class="empty-state">Failed to load.</div>';});
}
function closeDetailModal(){document.getElementById('detailModal').classList.remove('open');document.body.style.overflow='';currentModalId=null;}
function closeModalOverlay(ev){if(ev.target===document.getElementById('detailModal'))closeDetailModal();}
function toggleFullBody(){
    var t=document.getElementById('modalBodyText'),b=document.getElementById('bodyToggle');
    if(!t||!b)return; showingFullBody=!showingFullBody;
    t.textContent=showingFullBody?modalBodyFull:modalBodySummary;
    b.textContent=showingFullBody?'Show summary':'Show full body';
}
function modalApprove(){
    if(!currentModalId)return;
    var edits={doc_type:document.getElementById('modalDocType').value,discipline:document.getElementById('modalDiscipline').value,department:document.getElementById('modalDepartment').value};
    fetch('/api/pending/'+currentModalId+'/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(edits)})
    .then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Approved: '+d.transmittal_no,'success'); closeDetailModal(); fetchPending(); fetchEmails();
    }).catch(function(){showToast('Approve failed','error');});
}
function modalReject(){
    if(!currentModalId)return;
    fetch('/api/pending/'+currentModalId+'/reject',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;} showToast('Rejected','info'); closeDetailModal(); fetchPending();
    }).catch(function(){showToast('Reject failed','error');});
}
function modalMoveToReview(){
    if(!currentModalId)return;
    fetch('/api/pending/'+currentModalId+'/move-to-review',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;} showToast('Moved to review queue','success'); closeDetailModal(); fetchPending();
    }).catch(function(){showToast('Move failed','error');});
}
function modalReopenRejected(){
    if(!currentModalId)return;
    fetch('/api/pending/'+currentModalId+'/reopen',{method:'POST'}).then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;} showToast('Reopened for review','success'); closeDetailModal(); fetchPending();
    }).catch(function(){showToast('Reopen failed','error');});
}
function switchBodyView(view){
    currentBodyView=view;
    var textWrap=document.getElementById('bodyTextWrap'),htmlWrap=document.getElementById('bodyHtmlWrap');
    var btnText=document.getElementById('btnViewText'),btnHtml=document.getElementById('btnViewHtml');
    if(view==='html'){
        if(textWrap)textWrap.style.display='none';
        if(htmlWrap){htmlWrap.style.display='block';
            var frame=document.getElementById('bodyHtmlFrame');
            if(frame&&!frame.getAttribute('data-loaded')){frame.srcdoc=modalBodyHtml;frame.setAttribute('data-loaded','1');}
        }
        if(btnText)btnText.classList.remove('active');
        if(btnHtml)btnHtml.classList.add('active');
    } else {
        if(textWrap)textWrap.style.display='block';
        if(htmlWrap)htmlWrap.style.display='none';
        if(btnText)btnText.classList.add('active');
        if(btnHtml)btnHtml.classList.remove('active');
    }
}

// ---- Processed ----
var processedServerPage = 0, processedServerPages = 0, processedServerQuery = '';

function fetchEmails(page){
    if(page===undefined) page=0;
    var q=(document.getElementById('processedSearch')?document.getElementById('processedSearch').value:'').trim();
    processedServerQuery=q;
    fetch('/api/emails?q='+encodeURIComponent(q)+'&page='+page).then(function(r){return r.json();}).then(function(data){
        document.getElementById('statTotal').textContent=data.total;
        document.getElementById('statToday').textContent=data.today;
        document.getElementById('statAttach').textContent=data.with_attachments;
        processedEmails=data.emails||[];
        processedServerPage=data.page||0;
        processedServerPages=data.pages||0;
        renderProcessedTable();
    }).catch(function(){});
}

function toggleFollowUps(tn){
    var rows=document.querySelectorAll('.fu-row-'+CSS.escape(tn));
    var cards=document.querySelectorAll('.fu-card-'+CSS.escape(tn));
    var btn=document.getElementById('expand-'+tn);
    var showing=rows.length>0&&rows[0].style.display!=='none';
    rows.forEach(function(r){r.style.display=showing?'none':'table-row';});
    cards.forEach(function(c){c.style.display=showing?'none':'block';});
    if(btn) btn.textContent=showing?'+'+rows.length:'';
}
function renderProcessedTable(){
    var wrap=document.getElementById('emailTableWrap');
    var items=processedEmails;
    if(!items.length){wrap.innerHTML='<div class="empty-state">'+(processedServerQuery?'No matches.':'No emails processed yet.')+'</div>';return;}
    var html='';
    var page=processedServerPage, perPage=50;

    // Mobile cards
    html += '<div class="email-cards">';
    for(var i=0;i<items.length;i++){
        var e=items[i];
        var fups=e.follow_ups||[];
        var fuCount=fups.length;
        html+='<div class="email-card">';
        html+='<div class="card-row"><div style="flex:1;min-width:0">';
        var fuLabel=fuCount>0?' <span class="thread-badge thread-count">'+(fuCount+1)+' emails</span>':'';
        html+='<div style="font-weight:700;font-size:12px;color:var(--primary)">'+esc(e.transmittal_no)+fuLabel+'</div>';
        html+='<div class="card-subject" style="color:var(--text);cursor:default">'+esc(e.subject||'(no subject)')+'</div>';
        html+='<div class="card-meta">';
        html+='<span>'+esc(e.sender_name||e.sender)+'</span>';
        html+='<span>'+fmtTime(e.processed_at)+'</span>';
        if(e.attachment_count) html+='<span>'+e.attachment_count+' att.</span>';
        if(e.response_required) html+='<span class="resp-yes">Response needed</span>';
        html+='</div></div>';
        if(fuCount>0) html+='<button class="expand-btn" id="expand-'+esc(e.transmittal_no)+'" onclick="toggleFollowUps(\''+esc(e.transmittal_no)+'\')">+'+fuCount+'</button>';
        html+='</div>';
        html+='<div class="card-tags">';
        if(e.doc_type) html+='<span class="card-tag">'+esc(e.doc_type)+'</span>';
        if(e.discipline) html+='<span class="card-tag">'+esc(e.discipline)+'</span>';
        if(e.department) html+='<span class="card-tag">'+esc(e.department)+'</span>';
        html+='</div></div>';
        // Follow-up cards (hidden by default)
        for(var fi=0;fi<fups.length;fi++){
            var fu=fups[fi];
            html+='<div class="follow-up-card fu-card-'+esc(e.transmittal_no)+'" style="display:none">';
            html+='<div class="card-meta"><span class="follow-up-indicator">&#8627;</span>';
            html+='<span>'+esc(fu.sender_name||fu.sender)+'</span>';
            html+='<span>'+fmtTime(fu.processed_at)+'</span>';
            if(fu.attachment_count) html+='<span>'+fu.attachment_count+' att.</span>';
            html+='</div>';
            html+='<div style="margin-top:2px;color:var(--text)">'+esc(fu.subject||'(no subject)')+'</div>';
            html+='</div>';
        }
    }
    html += '</div>';

    // Desktop table
    var exp=viewModes.processed==='expanded'?' table-expanded':'';
    html+='<div class="table-wrap"><table class="'+exp+'"><thead><tr>'+
        '<th style="width:30px">#</th><th>Transmittal</th><th>Date</th><th>From</th><th>Subject</th>'+
        '<th>Type</th><th>Discipline</th><th>Dept.</th><th>Resp.</th><th>Att.</th></tr></thead><tbody>';
    for(var i=0;i<items.length;i++){
        var e=items[i], idx=page*perPage+i+1;
        var fups=e.follow_ups||[];
        var sd=esc(e.sender_name||e.sender);
        if(e.sender_company) sd+='<span class="sender-company">'+esc(e.sender_company)+'</span>';
        var rc=e.response_required?'resp-yes':'resp-no', rt=e.response_required?'Yes':'No';
        var fuBtn=fups.length>0?'<button class="expand-btn" id="expand-'+esc(e.transmittal_no)+'" onclick="toggleFollowUps(\''+esc(e.transmittal_no)+'\')">+'+fups.length+'</button>':'';
        html+='<tr><td class="col-num">'+idx+'</td>'+
            '<td><strong>'+esc(e.transmittal_no)+'</strong> '+fuBtn+'</td>'+
            '<td style="white-space:nowrap">'+fmtTime(e.processed_at)+'</td>'+
            '<td class="col-sender" title="'+esc(e.sender)+'">'+sd+'</td>'+
            '<td class="col-subject">'+esc(e.subject)+'</td>'+
            '<td>'+esc(e.doc_type||'')+'</td><td>'+esc(e.discipline||'')+'</td><td>'+esc(e.department||'')+'</td>'+
            '<td><span class="'+rc+'">'+rt+'</span></td><td>'+(e.attachment_count||0)+'</td></tr>';
        // Follow-up rows (hidden by default)
        for(var fi=0;fi<fups.length;fi++){
            var fu=fups[fi];
            var fsd=esc(fu.sender_name||fu.sender);
            if(fu.sender_company) fsd+='<span class="sender-company">'+esc(fu.sender_company)+'</span>';
            html+='<tr class="follow-up-row fu-row-'+esc(e.transmittal_no)+'" style="display:none">'+
                '<td></td>'+
                '<td><span class="follow-up-indicator">&#8627;</span></td>'+
                '<td style="white-space:nowrap">'+fmtTime(fu.processed_at)+'</td>'+
                '<td class="col-sender" title="'+esc(fu.sender)+'">'+fsd+'</td>'+
                '<td class="col-subject">'+esc(fu.subject)+'</td>'+
                '<td>'+esc(fu.doc_type||'')+'</td><td>'+esc(fu.discipline||'')+'</td><td>'+esc(fu.department||'')+'</td>'+
                '<td></td><td>'+(fu.attachment_count||0)+'</td></tr>';
        }
    }
    html+='</tbody></table></div>';
    // Server-side pagination
    if(processedServerPages>1){
        var totalItems=(processedServerPages*perPage);
        var from=page*perPage+1, to=page*perPage+items.length;
        html+='<div class="table-footer"><span>'+from+'-'+to+'</span><div class="pagination">';
        html+='<button class="page-btn" onclick="fetchEmails('+(page-1)+')"'+(page===0?' disabled':'')+'>&laquo;</button>';
        var maxBtns=isMobile?5:processedServerPages;
        var startP=Math.max(0,page-Math.floor(maxBtns/2));
        var endP=Math.min(processedServerPages,startP+maxBtns);
        if(endP-startP<maxBtns)startP=Math.max(0,endP-maxBtns);
        for(var i=startP;i<endP;i++){
            html+='<button class="page-btn'+(i===page?' active':'')+'" onclick="fetchEmails('+i+')">'+(i+1)+'</button>';
        }
        html+='<button class="page-btn" onclick="fetchEmails('+(page+1)+')"'+(page>=processedServerPages-1?' disabled':'')+'>&raquo;</button>';
        html+='</div></div>';
    }
    wrap.innerHTML=html;
}

// ---- Log ----
function toggleLog(){var b=document.getElementById('logBody'),t=document.getElementById('logToggle');b.classList.toggle('open');t.textContent=b.classList.contains('open')?'-':'+';if(b.classList.contains('open'))fetchLog();}
function fetchLog(){fetch('/api/log').then(function(r){return r.json();}).then(function(d){var b=document.getElementById('logBody');if(!d.lines||!d.lines.length){b.innerHTML='<div class="log-line">No log entries.</div>';return;}b.innerHTML=d.lines.map(function(l){return '<div class="log-line">'+esc(l)+'</div>';}).join('');b.scrollTop=b.scrollHeight;}).catch(function(){});}

// ---- Departments ----
function fetchDepartments(){
    fetch('/api/departments').then(function(r){return r.json();}).then(function(d){
        var depts=d.departments||[],w=document.getElementById('deptTableWrap');
        if(!depts.length){w.innerHTML='<div class="empty-state">No departments configured.</div>';return;}
        var html='';
        // Mobile cards
        html+='<div class="email-cards">';
        for(var i=0;i<depts.length;i++){
            var dp=depts[i],kws=[];try{kws=JSON.parse(dp.keywords||'[]');}catch(e){}
            var sc=dp.is_active?'active-badge':'inactive-badge',st=dp.is_active?'Active':'Inactive',tt=dp.is_active?'Deactivate':'Activate';
            html+='<div class="email-card">';
            html+='<div class="card-row"><div style="flex:1"><strong>'+esc(dp.name)+'</strong> <span class="'+sc+'">'+st+'</span></div></div>';
            if(dp.description) html+='<div class="dept-desc">'+esc(dp.description)+'</div>';
            if(kws.length) html+='<div class="card-tags">'+kws.map(function(k){return '<span class="card-tag">'+esc(k)+'</span>';}).join('')+'</div>';
            html+='<div class="card-actions">';
            html+='<button class="btn btn-ghost btn-sm" onclick="editDeptDesc('+dp.id+',this)">Edit Scope</button>';
            html+='<button class="btn btn-ghost btn-sm" onclick="toggleDept('+dp.id+','+(dp.is_active?'false':'true')+')">'+tt+'</button>';
            html+='<button class="btn btn-danger btn-sm" onclick="deleteDept('+dp.id+',\''+esc(dp.name)+'\')">Delete</button>';
            html+='</div></div>';
        }
        html+='</div>';
        // Desktop table
        html+='<div class="table-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Description / Scope</th><th>Keywords</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        for(var i=0;i<depts.length;i++){
            var dp=depts[i],kws=[];try{kws=JSON.parse(dp.keywords||'[]');}catch(e){}
            var kt=kws.map(function(k){return '<span class="tag">'+esc(k)+'</span>';}).join(' ');
            var sc=dp.is_active?'active-badge':'inactive-badge',st=dp.is_active?'Active':'Inactive',tt=dp.is_active?'Deactivate':'Activate';
            var descHtml=dp.description?'<span class="dept-desc" style="font-style:normal">'+esc(dp.description)+'</span>':'<span style="color:var(--text-light)">--</span>';
            html+='<tr><td class="col-num">'+(i+1)+'</td><td><strong>'+esc(dp.name)+'</strong></td><td>'+descHtml+'</td><td>'+(kt||'<span style="color:var(--text-light)">none</span>')+'</td><td><span class="'+sc+'">'+st+'</span></td><td class="col-actions"><div class="row-actions"><button class="btn btn-ghost btn-sm" onclick="editDeptDesc('+dp.id+',this)">Scope</button><button class="btn btn-ghost btn-sm" onclick="toggleDept('+dp.id+','+(dp.is_active?'false':'true')+')">'+tt+'</button><button class="btn btn-danger btn-sm" onclick="deleteDept('+dp.id+',\''+esc(dp.name)+'\')">Delete</button></div></td></tr>';
        }
        html+='</tbody></table></div>';
        w.innerHTML=html;
    }).catch(function(){});
}
function addDepartment(){var n=document.getElementById('deptName').value.trim(),k=document.getElementById('deptKeywords').value.trim(),desc=document.getElementById('deptDescription').value.trim();if(!n){showToast('Name required','error');return;}var kw=k?k.split(',').map(function(s){return s.trim();}).filter(Boolean):[];fetch('/api/departments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,keywords:kw,description:desc})}).then(function(r){return r.json();}).then(function(d){if(d.error){showToast(d.error,'error');return;}showToast('"'+n+'" added','success');document.getElementById('deptName').value='';document.getElementById('deptKeywords').value='';document.getElementById('deptDescription').value='';fetchDepartments();fetchClassificationOptions();}).catch(function(){showToast('Failed','error');});}
function editDeptDesc(id,btn){var desc=prompt('Enter department scope/description:');if(desc===null)return;fetch('/api/departments/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({description:desc})}).then(function(r){return r.json();}).then(function(d){if(d.error){showToast(d.error,'error');return;}showToast('Description updated','success');fetchDepartments();}).catch(function(){showToast('Failed','error');});}
function toggleDept(id,a){fetch('/api/departments/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({is_active:a})}).then(function(r){return r.json();}).then(function(){fetchDepartments();fetchClassificationOptions();}).catch(function(){});}
function deleteDept(id,n){if(!confirm('Delete "'+n+'"?'))return;fetch('/api/departments/'+id,{method:'DELETE'}).then(function(r){return r.json();}).then(function(){showToast('Deleted','info');fetchDepartments();fetchClassificationOptions();}).catch(function(){});}

// ---- Contacts ----
function fetchContacts(){
    fetch('/api/contacts').then(function(r){return r.json();}).then(function(d){
        var cs=d.contacts||[],w=document.getElementById('contactTableWrap');
        if(!cs.length){w.innerHTML='<div class="empty-state">No contacts added yet.</div>';return;}
        var html='';
        // Mobile cards
        html+='<div class="email-cards">';
        for(var i=0;i<cs.length;i++){
            var c=cs[i],sc=c.is_active?'active-badge':'inactive-badge',st=c.is_active?'Active':'Inactive',tt=c.is_active?'Deactivate':'Activate';
            html+='<div class="email-card">';
            html+='<div class="card-row"><div style="flex:1"><strong>'+esc(c.name)+'</strong> <span class="'+sc+'">'+st+'</span></div></div>';
            html+='<div class="card-meta">';
            html+='<span>'+esc(c.email)+'</span>';
            if(c.company) html+='<span>'+esc(c.company)+'</span>';
            if(c.department) html+='<span>'+esc(c.department)+'</span>';
            html+='</div>';
            if(c.notes) html+='<div style="font-size:11px;color:var(--text-muted)">'+esc(c.notes)+'</div>';
            html+='<div class="card-actions">';
            html+='<button class="btn btn-ghost btn-sm" onclick="toggleContact('+c.id+','+(c.is_active?'false':'true')+')">'+tt+'</button>';
            html+='<button class="btn btn-danger btn-sm" onclick="deleteContact('+c.id+',\''+esc(c.name)+'\')">Delete</button>';
            html+='</div></div>';
        }
        html+='</div>';
        // Desktop table
        html+='<div class="table-wrap"><table><thead><tr><th>#</th><th>Name</th><th>Email</th><th>Company</th><th>Dept.</th><th>Notes</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        for(var i=0;i<cs.length;i++){
            var c=cs[i],sc=c.is_active?'active-badge':'inactive-badge',st=c.is_active?'Active':'Inactive',tt=c.is_active?'Deactivate':'Activate';
            html+='<tr><td class="col-num">'+(i+1)+'</td><td><strong>'+esc(c.name)+'</strong></td><td>'+esc(c.email)+'</td><td>'+esc(c.company||'')+'</td><td>'+esc(c.department||'')+'</td><td>'+esc(c.notes||'')+'</td><td><span class="'+sc+'">'+st+'</span></td><td class="col-actions"><div class="row-actions"><button class="btn btn-ghost btn-sm" onclick="toggleContact('+c.id+','+(c.is_active?'false':'true')+')">'+tt+'</button><button class="btn btn-danger btn-sm" onclick="deleteContact('+c.id+',\''+esc(c.name)+'\')">Delete</button></div></td></tr>';
        }
        html+='</tbody></table></div>';
        w.innerHTML=html;
    }).catch(function(){});
}
function addContact(){var n=document.getElementById('contactName').value.trim(),e=document.getElementById('contactEmail').value.trim(),co=document.getElementById('contactCompany').value.trim(),dp=document.getElementById('contactDept').value.trim(),nt=document.getElementById('contactNotes').value.trim();if(!n||!e){showToast('Name & email required','error');return;}fetch('/api/contacts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,email:e,company:co,department:dp,notes:nt})}).then(function(r){return r.json();}).then(function(d){if(d.error){showToast(d.error,'error');return;}showToast('"'+n+'" added','success');document.getElementById('contactName').value='';document.getElementById('contactEmail').value='';document.getElementById('contactCompany').value='';document.getElementById('contactDept').value='';document.getElementById('contactNotes').value='';fetchContacts();}).catch(function(){showToast('Failed','error');});}
function toggleContact(id,a){fetch('/api/contacts/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({is_active:a})}).then(function(r){return r.json();}).then(function(){fetchContacts();}).catch(function(){});}
function deleteContact(id,n){if(!confirm('Delete "'+n+'"?'))return;fetch('/api/contacts/'+id,{method:'DELETE'}).then(function(r){return r.json();}).then(function(){showToast('Deleted','info');fetchContacts();}).catch(function(){});}

// ---- Classification Options ----
function fetchClassificationOptions(){fetch('/api/classification-options').then(function(r){return r.json();}).then(function(d){classificationOptions=d;}).catch(function(){});}

// ---- Classifier Info ----
function fetchClassifierInfo(){
    fetch('/api/classifier-info').then(function(r){return r.json();}).then(function(d){
        var sel=document.getElementById('classifierSelect');
        sel.value=d.method;
        var srcEl=document.getElementById('classifierSource');
        srcEl.textContent=d.source==='dashboard'?'Set from dashboard':'From config file ('+d.yaml_default+')';
        var chainEl=document.getElementById('classifierChain');
        chainEl.textContent=d.active_label;
        var kEl=document.getElementById('classifierKeys');
        var kh='';
        [{key:'gemini',label:'Gemini'},{key:'groq',label:'Groq'},{key:'claude',label:'Claude'}].forEach(function(k){
            kh+='<span class="key-pill '+(d.keys[k.key]?'on':'off')+'">'+k.label+(d.keys[k.key]?' ON':' OFF')+'</span>';
        }); kEl.innerHTML=kh;
    }).catch(function(){});
}
function changeClassifierMethod(){
    var sel=document.getElementById('classifierSelect');
    var method=sel.value;
    fetch('/api/settings/classifier-method',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({method:method})})
    .then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('Classifier set to '+d.active_label,'success');
        document.getElementById('classifierSource').textContent='Set from dashboard';
        document.getElementById('classifierChain').textContent=d.active_label;
    }).catch(function(){showToast('Failed to update classifier','error');});
}

// ---- AI Instructions ----
function toggleAiInstructions(){
    var body=document.getElementById('aiInstrBody'),tog=document.getElementById('aiInstrToggle');
    body.classList.toggle('open'); tog.classList.toggle('open');
    if(body.classList.contains('open')) fetchAiInstructions();
}
function fetchAiInstructions(){
    fetch('/api/settings/ai-instructions').then(function(r){return r.json();}).then(function(d){
        document.getElementById('aiInstructionsText').value=d.instructions||'';
        var meta=document.getElementById('aiInstrMeta');
        if(d.updated_at) meta.textContent='Last saved: '+fmtTime(d.updated_at);
        else meta.textContent='Not set yet';
    }).catch(function(){});
}
function saveAiInstructions(){
    var text=document.getElementById('aiInstructionsText').value;
    fetch('/api/settings/ai-instructions',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({instructions:text})})
    .then(function(r){return r.json();}).then(function(d){
        if(d.error){showToast(d.error,'error');return;}
        showToast('AI instructions saved','success');
        document.getElementById('aiInstrMeta').textContent='Last saved: '+fmtTime(new Date().toISOString());
    }).catch(function(){showToast('Failed to save instructions','error');});
}

// ---- Home Stats ----
function fetchHomeStats(){
    fetch('/api/home-stats').then(function(r){return r.json();}).then(function(d){
        document.getElementById('homePending').textContent=d.pending_review;
        document.getElementById('homeProcessed').textContent=d.total_processed;
        document.getElementById('homeDepts').textContent=d.departments;
        document.getElementById('homeContacts').textContent=d.contacts;
    }).catch(function(){});
}

// ---- Keyboard ----
document.addEventListener('keydown',function(e){if(e.key==='Escape'&&currentModalId)closeDetailModal();});

// ---- Init ----
fetchClassificationOptions(); fetchClassifierInfo(); fetchStatus(); fetchPending(); fetchHomeStats();
setInterval(function(){if(document.getElementById('tab-review').classList.contains('active')){fetchPending();fetchStatus();}},30000);
</script>
</body>
</html>
